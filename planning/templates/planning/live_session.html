<!DOCTYPE html>
{% load static tz %} {# Ensure 'tz' is loaded #}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Session: {% if session.school_group %}{{ session.school_group.name }}{% endif %} {{ session.date }}</title>
    <link rel="stylesheet" href="{% static 'planning/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"> 
    {# Add Tone.js CDN if you want sound later #}
    {# <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script> #}
    <style>
        /* Add specific styles if needed */
        .rotation-alert-info {
            font-weight: bold;
            color: #dc3545; /* Red color for alert */
            margin-left: 15px;
            font-size: 1.1em;
        }
        body.dark-mode .rotation-alert-info {
            color: #f1a1b1; /* Lighter red for dark mode */
        }
        .time-info {
            margin-bottom: 15px; /* Add some space below time info */
        }
        /* Ensure activity list shows something if empty after filtering */
        .activity-list:empty::after {
            content: "(No activities planned)";
            font-style: italic;
            color: var(--subheading-color, #666);
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    {# Add hidden spans to pass data to JavaScript #}
    <span id="is-simulated" data-is-simulated="{{ is_simulated|yesno:'true,false' }}" style="display: none;"></span>
    <span id="effective-time-iso" data-effective-time-iso="{{ effective_time_iso }}" style="display: none;"></span>
    <span id="next-rotation-time-iso" data-next-rotation-time-iso="{{ next_rotation_time_iso|default_if_none:'' }}" style="display: none;"></span>

    <a href="{% url 'planning:session_detail' session.id %}" class="back-link">
        <i class="bi bi-arrow-left"></i> Back to Session Plan
    </a>

    <div class="container">
        <h1>
            Live Session: {% if session.school_group %}{{ session.school_group.name }}{% endif %}
            ({{ session.date|date:"D, d M Y" }})
        </h1>

        {# --- Time Simulation Controls --- #}
        <div class="sim-form">
            <form method="get" action="">
                <label for="sim_time">Simulate Time:</label>
                {# Use the pre-formatted LOCAL time value for the input #}
                <input type="datetime-local" id="sim_time" name="sim_time" value="{{ sim_time_input_value }}">
                <button type="submit">Set Time</button>
                 {# Link to clear the sim_time parameter #}
                <a href="{% url 'planning:live_session' session.id %}">Use Real Time</a>
            </form>
        </div>

        {# --- Current Effective Time Display --- #}
        <p class="time-info">
            {# Display the LOCAL effective time using the 'localtime' filter or pre-converted variable #}
            Current Effective Time: {{ display_effective_time|date:"H:i:s" }} {{ display_effective_time|date:"e" }} {# 'e' shows timezone name like SAST if available #}
            {% if is_simulated %}
                <span class="simulated-note"> (Simulated)</span>
            {% endif %}
            {# --- Display Next Rotation Time --- #}
            {% if display_next_rotation_time %} {# Check the localized datetime object passed from view #}
                <span class="rotation-alert-info">
                     Next Rotation At: {{ display_next_rotation_time|time:"H:i" }} {# Use standard time filter #}
                </span>
            {% elif current_block_data and current_block_data.block.rotation_interval_minutes %}
                 <span class="rotation-alert-info">(No further rotations in this block)</span>
            {% endif %}
            {# --- End Display Next Rotation Time --- #}
        </p>
        <hr>

        {# --- Current/Next Block Display --- #}
        {% if current_block_data %}
            <div class="live-block current">
                <h2>Current Block: {{ current_block_data.block.block_start_datetime|localtime|time:"H:i" }} - {{ current_block_data.block.block_end_datetime|localtime|time:"H:i" }}</h2>
                 {% if current_block_data.block.block_focus %} <p><strong>Focus:</strong> {{ current_block_data.block.block_focus }}</p> {% endif %}
                 {% if current_block_data.block.rotation_interval_minutes %} <p><strong>Rotation Interval:</strong> {{ current_block_data.block.rotation_interval_minutes }} minutes</p> {% endif %}
                <div class="live-courts-container">
                    {% for court_num, players in current_block_data.assignments.items|dictsort:0 %}
                        <div class="live-court-column">
                            <h4>Court {{ court_num }}</h4>
                            <strong>Players:</strong>
                            <ul class="player-list">
                                {% for player in players %}
                                    <li><a href="{% url 'planning:player_profile' player.id %}">{{ player.full_name }}</a></li>
                                {% empty %}
                                    <li>--</li>
                                {% endfor %}
                            </ul>
                            <strong>Activities:</strong>
                            <ul class="activity-list">
                                {# Loop through activities and display if they match #}
                                {% for activity in current_block_data.block_activities %}
                                     {% if activity.court_number == court_num %}
                                        <li>
                                            {% if activity.drill %}{{ activity.drill.name }}{% else %}{{ activity.custom_activity_name }}{% endif %}
                                            ({{ activity.duration_minutes }} min)
                                            {% if activity.lead_coach %} [{{ activity.lead_coach.name }}]{% endif %}
                                        </li>
                                     {% endif %}
                                {% endfor %}
                                {# Removed invalid filter/set block. Empty list handled by CSS :empty selector #}
                            </ul>
                        </div>
                    {% empty %}
                         <p class="no-data-msg" style="grid-column: 1 / -1;">No courts defined or players assigned for this block.</p> {# Span full width #}
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {% if next_block_data %}
             <div class="live-block next">
                <h2>Next Block: {{ next_block_data.block.block_start_datetime|localtime|time:"H:i" }} - {{ next_block_data.block.block_end_datetime|localtime|time:"H:i" }}</h2>
                 {% if next_block_data.block.block_focus %} <p><strong>Focus:</strong> {{ next_block_data.block.block_focus }}</p> {% endif %}
                 <p style="font-style:italic;">(Assignments below show initial placement for the next block)</p>
                <div class="live-courts-container">
                     {% for court_num, players in next_block_data.assignments.items|dictsort:0 %}
                        <div class="live-court-column">
                            <h4>Court {{ court_num }}</h4>
                            <strong>Players:</strong>
                            <ul class="player-list">
                                {% for player in players %}
                                    <li><a href="{% url 'planning:player_profile' player.id %}">{{ player.full_name }}</a></li>
                                {% empty %}
                                    <li>--</li>
                                {% endfor %}
                            </ul>
                            <strong>Activities:</strong>
                            <ul class="activity-list">
                                {# Loop through activities and display if they match #}
                                {% for activity in next_block_data.block_activities %}
                                     {% if activity.court_number == court_num %}
                                        <li>
                                            {% if activity.drill %}{{ activity.drill.name }}{% else %}{{ activity.custom_activity_name }}{% endif %}
                                            ({{ activity.duration_minutes }} min)
                                            {% if activity.lead_coach %} [{{ activity.lead_coach.name }}]{% endif %}
                                        </li>
                                     {% endif %}
                                {% endfor %}
                                {# Removed invalid filter/set block. Empty list handled by CSS :empty selector #}
                            </ul>
                        </div>
                    {% empty %}
                         <p class="no-data-msg" style="grid-column: 1 / -1;">No courts defined or players assigned for the next block.</p> {# Span full width #}
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {% if not current_block_data and not next_block_data %}
            <p>Session has ended or not started yet according to the effective time.</p>
        {% endif %}

         <hr>
        <p><a href="{% url 'planning:session_detail' session.id %}" class="back-link">Back to Full Session Plan</a></p>

    </div> {# End container #}

    {# --- Rotation Alert JavaScript --- #}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const isSimulatedElement = document.getElementById('is-simulated');
            const effectiveTimeElement = document.getElementById('effective-time-iso');
            const nextRotationElement = document.getElementById('next-rotation-time-iso');

            // Ensure elements exist before proceeding
            if (!isSimulatedElement || !effectiveTimeElement || !nextRotationElement) {
                console.error("Required time elements not found for rotation alert.");
                return;
            }

            const isSimulated = isSimulatedElement.dataset.isSimulated === 'true';
            const effectiveTimeISO = effectiveTimeElement.dataset.effectiveTimeIso;
            const nextRotationISO = nextRotationElement.dataset.nextRotationTimeIso;

            // Flag to prevent multiple alerts for the same rotation time
            // Use sessionStorage to persist flag across page reloads caused by simulation form
            let alertShownForThisTimestamp = sessionStorage.getItem('alertShownFor_' + nextRotationISO);

            // Only proceed if there's a next rotation time calculated
            if (nextRotationISO) {
                const nextRotationTimestamp = Date.parse(nextRotationISO); // Get timestamp (milliseconds since epoch, UTC)

                if (isNaN(nextRotationTimestamp)) {
                     console.error("Could not parse next rotation time:", nextRotationISO);
                     return;
                }

                const checkRotation = () => {
                    // Re-check flag in case it was set by another check
                    alertShownForThisTimestamp = sessionStorage.getItem('alertShownFor_' + nextRotationISO);
                    if (alertShownForThisTimestamp === 'true') {
                        // If flag is set, clear interval if it exists and stop
                        if (rotationCheckInterval) clearInterval(rotationCheckInterval);
                        return;
                    }

                    let currentTimestamp;
                    if (isSimulated) {
                        // For simulation, use the fixed effective time passed from the view
                        currentTimestamp = Date.parse(effectiveTimeISO);
                         if (isNaN(currentTimestamp)) {
                             console.error("Could not parse simulated effective time:", effectiveTimeISO);
                             if (rotationCheckInterval) clearInterval(rotationCheckInterval); // Stop checking if time is bad
                             return;
                         }
                    } else {
                        // For real time, use the browser's current time
                        currentTimestamp = Date.now();
                    }

                    // Check if current time has reached or passed the next rotation time
                    if (currentTimestamp >= nextRotationTimestamp) {
                        console.log("Rotation time reached!");
                        // --- Trigger Alert ---
                        alert("Time to rotate courts!");
                        // --- Optional: Add sound here later using Tone.js ---
                        // const synth = new Tone.Synth().toDestination();
                        // synth.triggerAttackRelease("C5", "8n"); // Example sound

                        // Set flag in sessionStorage to persist across reloads
                        sessionStorage.setItem('alertShownFor_' + nextRotationISO, 'true');
                        alertShownForThisRotation = 'true'; // Update local flag too

                        // Clear the interval if it exists
                        if (rotationCheckInterval) {
                             clearInterval(rotationCheckInterval);
                             console.log("Rotation alert shown, interval cleared.");
                        }
                    }
                };

                // --- Set up checking ---
                let rotationCheckInterval = null;
                if (isSimulated) {
                    // If simulated, check only once on load
                    checkRotation();
                } else {
                    // If real-time, check periodically (e.g., every 5 seconds)
                    // Check immediately first
                    checkRotation();
                    // Then check every 5 seconds ONLY if alert hasn't been shown
                    if (alertShownForThisTimestamp !== 'true') {
                        rotationCheckInterval = setInterval(checkRotation, 5000); // Check every 5000ms (5 seconds)
                        console.log("Rotation check interval started.");
                    } else {
                         console.log("Rotation alert already shown for this time, not starting interval.");
                    }
                }
            } else {
                 console.log("No upcoming rotation time found for the current block.");
            }
        });
    </script>
    {# --- END Rotation Alert JavaScript --- #}

</body>
</html>
