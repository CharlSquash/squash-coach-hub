<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live: {% if session.school_group %}{{ session.school_group.name }}{% else %}Session{% endif %} {{ session.date }}</title>
    <link rel="stylesheet" href="{% static 'planning/style.css' %}">
    <style>
        /* Styles from previous steps... */
        body { background-color: #e9ecef; font-size: 16px; }
        .live-container { max-width: 95%; margin: 15px auto; }
        .live-block { background-color: #fff; border: 2px solid #007bff; border-radius: 8px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .live-block.next { border-color: #fd S17e; background-color: #fff S1e5; }
        .live-block.current h2 { color: #007bff; } .live-block.next h2 { color: #dda S100; }
        .live-block h2 { font-size: 1.8em; border: none; margin: 0 0 15px 0;}
        .live-courts-container { display: flex; gap: 25px; margin-top: 15px; flex-wrap: wrap; }
        .live-court-column { background-color: #f S1f S1f S1; border: 1px solid #dee S1e6; padding: 15px; border-radius: 5px; flex: 1; min-width: 280px; }
        .live-court-column h4 { font-size: 1.3em; color: #495057; border-bottom: 1px solid #eee; padding-bottom: 5px; margin: 0 0 10px 0;}
        .player-list, .activity-list { padding-left: 5px; margin-bottom: 15px;}
        .player-list li, .activity-list li { font-size: 1.1em; margin-bottom: 8px; }
        .activity-list li { background-color: #e S1f S1f3; padding: 6px 10px; border-radius: 4px; border: 1px solid #cfe2ff;}
        .no-data { font-style: italic; color: #6c757d; }
        .time-info { font-size: 1.1em; font-weight: bold; margin-bottom: 10px; color: #5a6268; } /* Reduced margin */
        .simulated-note { color: #dc3545; font-weight: bold; background-color: #f8d7da; padding: 5px; border-radius: 3px; display:inline-block; margin-left: 10px;}
        /* Styles for the simulation form */
        .sim-form { background-color: #f S1f S1f S1; padding: 15px; border-radius: 5px; border: 1px solid #ccc; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap;}
        .sim-form label { font-weight: bold; margin-right: 5px;}
        .sim-form input[type="datetime-local"] { padding: 5px; border: 1px solid #ccc; border-radius: 3px;}
        .sim-form button { padding: 5px 10px; font-size: 0.9em; background-color: #6c757d; }
        .sim-form button:hover { background-color: #5a6268;}
        .sim-form a { font-size: 0.9em; }

        /* Hide elements not needed in live view */
        .add-link, .edit-link, .delete-link, .activity-actions { display: none !important; }
    </style>
</head>
<body>
<div class="live-container">
    <h1>Live Session View: {% if session.school_group %}{{ session.school_group.name }}{% else %}Session{% endif %} - {{ session.date|date:"D, d M Y" }}</h1>

    {# --- SIMULATION FORM --- #}
    <div class="sim-form">
        <form method="get" action="" style="display: contents;"> {# Use GET to submit to current URL #}
            <label for="sim_time_input">Simulate Time:</label>
            {# Value format MUST be YYYY-MM-DDTHH:MM #}
            <input type="datetime-local" id="sim_time_input" name="sim_time"
                   value="{{ sim_time_value }}"> {# Use formatted value from view #}
            <button type="submit">Set Time</button>
        </form>
        {# Link to clear the sim_time parameter and use real time #}
        <a href="{% url 'planning:live_session' session.id %}">Use Real Time</a>
    </div>
    {# --- END SIMULATION FORM --- #}

    <p class="time-info">
        Effective Time: {{ effective_time|time:"H:i:s" }}
        {% if is_simulated %}
            <span class="simulated-note">(Simulated)</span>
        {% endif %}
    </p>


    {# --- Display Current Block --- #}
    {% if current_block_data %}
        {% with block=current_block_data.block assignments=current_block_data.assignments block_activities=current_block_data.block_activities %}
            <div class="live-block current">
                <h2>Now: {{ block.block_start_datetime|time:"H:i" }} - {{ block.block_end_datetime|time:"H:i" }} ({{ block.duration_minutes }} min) {% if block.block_focus %}- {{ block.block_focus }}{% endif %}</h2>
                <div class="live-courts-container">
                    {% for court_num, players in assignments.items|dictsort:0 %}
                        <div class="live-court-column">
                            <h4>Court {{ court_num }}</h4>
                            <strong>Players:</strong>
                            <ul class="player-list">
                                {% for player in players %}<li>{{ player.full_name }}</li>{% empty %}<li>--</li>{% endfor %}
                            </ul>
                            <strong>Activities Now:</strong>
                            <ul class="activity-list">
                                {% for activity in block_activities %}
                                    {% if activity.court_number == court_num %}
                                        <li>
                                            {% if activity.drill %}{{ activity.drill.name }}{% else %}{{ activity.custom_activity_name }}{% endif %}
                                            ({{ activity.duration_minutes }} min)
                                            {% if activity.lead_coach %} [{{ activity.lead_coach.name }}] {% endif %}
                                        </li>
                                    {% endif %}
                                {% empty %}
                                    <li class="no-data">No activities planned.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% empty %}
                        <p class="no-data">No courts defined for this block.</p>
                    {% endfor %}
                </div>
            </div>
        {% endwith %}
    {% else %}
        <div class="live-block">
            <h2>Session Not Started or Already Finished</h2>
            <p>(Effective time: {{ effective_time|time:"H:i:s" }})</p>
        </div>
    {% endif %}

     {# --- Display Next Block --- #}
    {% if next_block_data %}
        {% with block=next_block_data.block assignments=next_block_data.assignments block_activities=next_block_data.block_activities %}
             <div class="live-block next">
                <h2>Next: {{ block.block_start_datetime|time:"H:i" }} - {{ block.block_end_datetime|time:"H:i" }} ({{ block.duration_minutes }} min) {% if block.block_focus %}- {{ block.block_focus }}{% endif %}</h2>
                 <div class="live-courts-container">
                     {% for court_num, players in assignments.items|dictsort:0 %}
                         <div class="live-court-column">
                             <h4>Court {{ court_num }}</h4>
                             <strong>Players:</strong>
                             <ul class="player-list">
                                 {% for player in players %}<li>{{ player.full_name }}</li>{% empty %}<li>--</li>{% endfor %}
                             </ul>
                              <strong>Activities Next:</strong>
                             <ul class="activity-list">
                                 {% for activity in block_activities %}
                                     {% if activity.court_number == court_num %}
                                         <li>
                                             {% if activity.drill %}{{ activity.drill.name }}{% else %}{{ activity.custom_activity_name }}{% endif %}
                                             ({{ activity.duration_minutes }} min)
                                             {% if activity.lead_coach %} [{{ activity.lead_coach.name }}] {% endif %}
                                         </li>
                                     {% endif %}
                                 {% empty %}
                                     <li class="no-data">No activities planned.</li>
                                 {% endfor %}
                             </ul>
                         </div>
                     {% empty %}
                        <p class="no-data">No courts defined for this block.</p>
                     {% endfor %}
                </div>
             </div>
         {% endwith %}
    {% elif current_block_data %}
        <div class="live-block next">
             <h2>End of Session</h2>
        </div>
    {% endif %}

    <p style="margin-top: 30px;"><a href="{% url 'planning:session_detail' session.id %}">View/Edit Full Plan</a></p>

</div> {# End live-container #}
</body>
</html>