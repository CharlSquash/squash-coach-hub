{% extends "planning/base.html" %}
{% load static %}
{% load tz %}

{% block title %}{{ page_title|default:"Live Session View" }} - SquashSync{% endblock %}

{% block extra_head %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--body-bg, #f4f7f6);
            color: var(--text-color, #333);
            margin: 0;
            padding: 0; 
            transition: padding-top 0.3s ease-in-out; 
        }
        
        /* --- Fullscreen Lock Mode Styles --- */
        body.fullscreen-locked-mode .main-header, 
        body.fullscreen-locked-mode .main-footer, 
        body.fullscreen-locked-mode .django-messages,
        body.fullscreen-locked-mode .page-header, 
        body.fullscreen-locked-mode .simulation-controls,
        body.fullscreen-locked-mode .top-controls-container .view-mode-selector,
        body.fullscreen-locked-mode .top-controls-container #toggleSoundBtn,
        body.fullscreen-locked-mode #liveStatusContainer #currentBlockInfo, 
        body.fullscreen-locked-mode #liveStatusContainer #nextBlockPreviewInfo,
        body.fullscreen-locked-mode #liveStatusContainer h1.session-title-locked {
            display: none !important;
        }

        body.fullscreen-locked-mode #toggleLockViewBtn {
            position: fixed; bottom: 10px; right: 10px; z-index: 10001; 
            padding: 6px 10px; font-size: 0.8em; 
        }
        body.fullscreen-locked-mode .live-session-wrapper {
             height: 100vh; overflow: hidden; display: flex; flex-direction: column; padding: 5px; 
        }
        body.fullscreen-locked-mode #liveStatusContainer {
             flex-shrink: 0; padding: 5px 0; 
             text-align: center; margin-bottom: 5px; 
        }
         body.fullscreen-locked-mode #liveStatusContainer h2#sessionStatusMessage {
            font-size: 1.0em; margin-bottom: 2px;
        }
        body.fullscreen-locked-mode #liveStatusContainer #nextRotationInfo { 
            display: block !important; 
            font-size: 0.8em; 
            margin-top: 2px;
            color: var(--subheading-color); 
        }
        body.fullscreen-locked-mode #liveStatusContainer #nextRotationInfo .time-remaining {
            font-size: 1.1em; 
        }


        body.fullscreen-locked-mode #courtsArea {
             flex-grow: 1; overflow-y: auto; min-height: 0; 
             display: grid; 
             grid-template-columns: repeat(auto-fit, minmax(min(100%, 170px), 1fr)); 
             gap: 4px; padding: 0 2px; box-sizing: border-box; 
        }

        body.fullscreen-locked-mode.single-court-view #courtsArea {
             display: flex; align-items: stretch; padding: 2px; 
        }
        body.fullscreen-locked-mode.single-court-view .court-card {
             flex-grow: 1; display: flex; flex-direction: column; min-height: 0; padding: 4px; 
        }
        body.fullscreen-locked-mode .court-card {
            padding: 4px; 
        }
        body.fullscreen-locked-mode .court-card h3 { 
             margin-top: 2px; margin-bottom: 2px; font-size: 0.9em; padding-bottom: 2px;
        }
        body.fullscreen-locked-mode .court-card .activity-info {
             flex-shrink: 0; margin-bottom: 2px; 
        }
         body.fullscreen-locked-mode .court-card .activity-info h4 { 
            font-size: 0.7em; margin-bottom: 1px;
        }
        body.fullscreen-locked-mode .court-card .activity-info p { 
            font-size: 0.8em; margin-bottom: 2px; line-height: 1.2; 
        }
        body.fullscreen-locked-mode .court-card .circle-timer-container {
             width: 60px; height: 60px; margin: 2px auto 3px auto; 
        }
         body.fullscreen-locked-mode .progressbar-text { 
            font-size: 1.0em; 
        }
        body.fullscreen-locked-mode .court-card .next-activity {
             flex-shrink: 0; margin-top: 2px; padding-top: 2px; font-size: 0.6em; line-height: 1.2;
        }
        body.fullscreen-locked-mode .court-card .player-list-container { 
             flex-grow: 1; overflow-y: auto; min-height: 20px; 
             border-top: 1px solid var(--border-light); margin-top: 2px; padding-top: 2px;
        }
        body.fullscreen-locked-mode .court-card .player-list-container h4 { 
            font-size: 0.7em; margin-bottom: 1px;
        }
        body.fullscreen-locked-mode .court-card .player-list {
            font-size: 0.65em; line-height: 1.2;
        }
         body.fullscreen-locked-mode .court-card .player-list li {
            padding: 1px 0;
        }
        /* End of Fullscreen Lock Mode Styles */

        /* Pre-session player list styles */
        .pre-session-player-list {
            margin-top: 15px; padding: 10px; background-color: var(--container-light-bg);
            border-radius: 8px; text-align: center;
        }
        .pre-session-player-list h4 {
            margin-top: 0; margin-bottom: 8px; color: var(--subheading-color); font-size: 1.1em;
        }
        .pre-session-player-list ul {
            list-style: none; padding: 0; margin: 0; display: flex;
            flex-wrap: wrap; justify-content: center; gap: 8px 15px; 
        }
        .pre-session-player-list li {
            font-size: 0.95em; color: var(--text-color); background-color: var(--container-bg);
            padding: 5px 10px; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* General Styles (from previous version) */
        .live-session-wrapper { padding: 10px; max-width: 100%; box-sizing: border-box; }
        .page-header h1 { font-size: 1.5em; color: var(--heading-color); margin-bottom: 15px; text-align: center; }
        .simulation-controls { background-color: var(--container-light-bg, #f0f0f0); padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border-color, #ddd); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .simulation-controls h4 { margin-top: 0; margin-bottom: 10px; color: var(--subheading-color); font-size: 1.1em; }
        .sim-form-row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; margin-bottom: 8px; }
        .sim-form-row label { font-weight: bold; font-size: 0.9em; margin-right: 5px; }
        .sim-form-row input[type="datetime-local"], .sim-form-row button { padding: 8px 10px; border-radius: 4px; border: 1px solid var(--border-color); font-size: 0.9em; background-color: var(--input-bg); color: var(--text-color); }
        .sim-form-row button { background-color: var(--link-color); color: var(--container-bg, #fff); cursor: pointer; }
        .sim-form-row button:hover { background-color: var(--link-hover-color); }
        #currentPollTimeDisplay, #apiUrlDisplay { font-size: 0.75em; color: var(--text-color-muted, #6c757d); word-break: break-all; line-height: 1.3; }
        html.dark-mode #currentPollTimeDisplay, html.dark-mode #apiUrlDisplay { color: var(--subheading-color); }
        #liveStatusContainer { background-color: var(--container-bg, #fff); padding: 10px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border-color, #ddd); text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); min-height: 70px; }
        #liveStatusContainer.rotation-alert-active { background-color: #ffc107 !important; color: #333 !important; font-weight: bold; animation: flashAlert 1s infinite alternate; }
        @keyframes flashAlert { from { opacity: 1; } to { opacity: 0.7; } }
        #liveStatusContainer h2 { margin: 0 0 5px 0; font-size: 1.3em; color: var(--heading-color); }
        #liveStatusContainer p { margin: 3px 0 0 0; font-size: 0.9em; color: var(--subheading-color); }
        #liveStatusContainer .time-remaining, .court-card .time-remaining { font-weight: bold; font-size: 1.1em; color: var(--link-color); }
        #courtsArea { display: grid; grid-template-columns: repeat(auto-fit, minmax(min(100%, 220px), 1fr)); gap: 8px; }
        .court-card { background-color: var(--container-bg, #fff); border: 2px solid var(--border-color, #ddd); padding: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: center; }
        .court-card.court-active { border-color: var(--link-color); }
        .court-card h3 { margin-top: 0; margin-bottom: 8px; font-size: 1.3em; color: var(--heading-color); text-align: center; border-bottom: 1px solid var(--border-light); padding-bottom: 5px; width:100%; }
        .court-card .activity-info { width: 100%; text-align: center; }
        .court-card .activity-info h4 { font-size: 1em; margin: 0 0 3px 0; color: var(--subheading-color); }
        .court-card .activity-info p { margin: 3px 0 8px 0; font-size: 1em; font-weight: bold; }
        .circle-timer-container { width: 100px; height: 100px; margin: 5px auto 10px auto; position: relative; }
        .progressbar-text { color: var(--text-color, #333) !important; font-weight: bold; font-size: 1.4em; }
        .court-card .next-activity { font-size: 0.8em; color: var(--text-color-muted, #6c757d); margin-top: 8px; border-top: 1px dashed var(--border-light); padding-top: 8px; width:100%; text-align:center; }
        html.dark-mode .court-card .next-activity { color: var(--subheading-color); }
        .court-card .player-list-container { width:100%; text-align:center; }
        .court-card .player-list-container h4 { font-size: 1em; margin: 8px 0 3px 0; color: var(--subheading-color); }
        .court-card .player-list { list-style: none; padding-left: 0; margin-top: 0; font-size: 0.85em; }
        .court-card .player-list li { padding: 2px 0; }
        .court-card .no-activity { font-style: italic; color: var(--subheading-color); text-align: center; padding: 15px 0; }
        .top-controls-container { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 15px; margin-bottom: 20px; }
        .view-mode-selector { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px; }
        .view-mode-selector button, .view-mode-selector label, .view-mode-selector select, .control-button { padding: 8px 10px; margin: 3px; font-size: 0.9em; border-radius: 4px; cursor: pointer; border: 1px solid var(--border-color); background-color: var(--container-light-bg); color: var(--text-color); }
        .view-mode-selector button.active, .control-button.active { background-color: var(--link-color); color: var(--container-bg, #fff); border-color: var(--link-color); }
        #toggleLockViewBtn.unlock-mode { background-color: var(--danger-color, #dc3545) !important; color: white !important; } 
        .view-mode-selector label { border: none; background: none; padding: 8px 0; }
        .single-court-view #courtsArea:not(body.fullscreen-locked-mode.single-court-view #courtsArea) { grid-template-columns: 1fr; }
        .single-court-view .court-card:not(body.fullscreen-locked-mode.single-court-view .court-card) { border-width: 3px; }
        #pinModal { display: none; }

        @media (max-width: 480px) { 
            body.fullscreen-locked-mode #courtsArea { grid-template-columns: repeat(auto-fit, minmax(min(100%, 150px), 1fr)); }
            body.fullscreen-locked-mode .court-card .circle-timer-container { width: 50px; height: 50px; margin: 2px auto 3px auto; }
            body.fullscreen-locked-mode .progressbar-text { font-size: 0.9em; }
            body.fullscreen-locked-mode .court-card h3 { font-size: 0.8em; }
            body.fullscreen-locked-mode .court-card .activity-info h4 { font-size: 0.65em; }
            body.fullscreen-locked-mode .court-card .activity-info p { font-size: 0.75em; }
            body.fullscreen-locked-mode .court-card .next-activity { font-size: 0.6em; }
            body.fullscreen-locked-mode .court-card .player-list-container h4 { font-size: 0.65em; }
            body.fullscreen-locked-mode .court-card .player-list { font-size: 0.6em; }
        }
    </style>
{% endblock %}

{% block content %}
<div class="live-session-wrapper">
    <div class="page-header">
        <h1>{{ page_title|default:"Live Session" }}</h1>
    </div>

    {% if user.is_superuser %}
    <div class="simulation-controls">
        <h4><i class="bi bi-clock-history"></i> Session Time Simulation</h4>
        <div class="sim-form-row">
            <label for="simTimeInput">Set Simulated Time (Local):</label>
            <input type="datetime-local" id="simTimeInput" step="1"> 
        </div>
        <div class="sim-form-row">
            <button id="setSimTimeBtn">Set & Refresh Now</button>
            <button id="useRealTimeBtn">Use Real Time</button>
            <button id="advanceTimeBtn">Advance 5 Min</button>
        </div>
        <p><small>Current time for API poll: <span id="currentPollTimeDisplay">Real Time</span></small><br>
            <small>API URL for state: <span id="apiUrlDisplay">(will be shown on poll)</span></small>
        </p>
    </div>
    {% endif %}

    <div class="top-controls-container">
        <div class="view-mode-selector">
            <button id="viewAllCourtsBtn" class="active">View All Courts</button>
            <label for="selectCourtView">View Specific Court:</label>
            <select id="selectCourtView">
                <option value="all">-- Select Court --</option>
                {% for i in ""|ljust:number_of_courts %}
                    <option value="{{ forloop.counter }}">Court {{ forloop.counter }}</option>
                {% endfor %}
            </select>
        </div>
        <button id="toggleSoundBtn" class="control-button">Mute Sounds</button>
        <button id="toggleLockViewBtn" class="control-button">Lock View</button>
    </div>

    <div id="liveStatusContainer">
        <h2 id="sessionStatusMessage">Loading live status...</h2>
        <div id="preSessionPlayerListContainer" style="display: none;"></div> 
        <p id="currentBlockInfo"></p> 
        <p id="nextRotationInfo"></p>       
        <p id="nextBlockPreviewInfo"></p> 
    </div>

    <div id="courtsArea">
        <p class="no-data" style="text-align:center;">Loading court data...</p>
    </div>
</div>

<div id="pinModal">
    <div> 
        <h4>Enter PIN to Unlock</h4>
        <input type="password" id="pinInput" inputmode="numeric" pattern="[0-9]*">
        <p id="pinErrorMessage"></p>
        <button id="pinSubmitBtn" class="control-button" style="background-color: var(--link-color); color: white; margin-right: 10px;">Enter</button>
        <button id="pinCancelBtn" class="control-button">Cancel</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
    {% load static %}
    <script src="{% static 'planning/js/progressbar.min.js' %}"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM fully loaded. Starting Live Session JS."); // LOG 1

        // --- START: Variable Declarations and Element Getters ---
        const sessionId = "{{ session.id|escapejs }}"; 
        let apiUrlForSessionState = "";
        let initialPageError = null; 

        const SSEL_GLOBAL = document.getElementById('sessionStatusMessage'); 

        if (typeof ProgressBar === 'undefined') {
            initialPageError = "Error: UI Component (ProgressBar.js) missing. Timers disabled.";
            console.error(initialPageError);
            if (SSEL_GLOBAL) SSEL_GLOBAL.textContent = initialPageError;
            const CA_pb_err = document.getElementById('courtsArea');
            if (CA_pb_err) CA_pb_err.innerHTML = '<p class="no-data">Page Error: Cannot initialize timers.</p>';
            return; 
        }
        console.log("ProgressBar.js loaded successfully."); // LOG 2
        
        try { 
            apiUrlForSessionState = "{% url 'planning:live_session_update_api' session.id %}"; 
            if (!apiUrlForSessionState) { 
                throw new Error("Django URL tag for API returned empty string.");
            }
            console.log("API URL successfully constructed:", apiUrlForSessionState); // LOG 3
        } catch(e) { 
            console.error("CRITICAL: API URL construction failed:", e); 
            initialPageError = "Error: API URL misconfiguration. Cannot load session data.";
        }
        
        const liveStatusContainer = document.getElementById('liveStatusContainer');
        const currentBlockInfoEl = document.getElementById('currentBlockInfo');
        const nextRotationInfoEl = document.getElementById('nextRotationInfo');
        const nextBlockPreviewInfoEl = document.getElementById('nextBlockPreviewInfo');
        const courtsAreaDiv = document.getElementById('courtsArea');
        const preSessionPlayerListContainer = document.getElementById('preSessionPlayerListContainer');
        
        const simTimeInput = document.getElementById('simTimeInput');
        const setSimTimeBtn = document.getElementById('setSimTimeBtn');
        const useRealTimeBtn = document.getElementById('useRealTimeBtn');
        const advanceTimeBtn = document.getElementById('advanceTimeBtn');
        const currentPollTimeDisplay = document.getElementById('currentPollTimeDisplay');
        const apiUrlDisplay = document.getElementById('apiUrlDisplay');
        if(apiUrlDisplay && apiUrlForSessionState) apiUrlDisplay.textContent = apiUrlForSessionState;

        const viewAllCourtsBtn = document.getElementById('viewAllCourtsBtn');
        const selectCourtViewDropdown = document.getElementById('selectCourtView');
        const toggleSoundBtn = document.getElementById('toggleSoundBtn');
        const toggleLockViewBtn = document.getElementById('toggleLockViewBtn'); 

        const pinModal = document.getElementById('pinModal');
        const pinInput = document.getElementById('pinInput');
        const pinSubmitBtn = document.getElementById('pinSubmitBtn');
        const pinCancelBtn = document.getElementById('pinCancelBtn');
        const pinErrorMessage = document.getElementById('pinErrorMessage');

        if (initialPageError) {
            if (SSEL_GLOBAL) SSEL_GLOBAL.textContent = initialPageError;
            if (courtsAreaDiv) courtsAreaDiv.innerHTML = '<p class="no-data">Page Error: Cannot load session.</p>';
            if (toggleLockViewBtn) toggleLockViewBtn.disabled = true;
            if (toggleSoundBtn) toggleSoundBtn.disabled = true;
            console.log("Script execution halted due to initialPageError."); // LOG 4
            return; 
        }

        const requiredElements = { 
            liveStatusContainer, sessionStatusMessageEl: SSEL_GLOBAL, courtsAreaDiv, preSessionPlayerListContainer,
            viewAllCourtsBtn, selectCourtViewDropdown, toggleSoundBtn, toggleLockViewBtn,
            pinModal, pinInput, pinSubmitBtn, pinCancelBtn 
        };
        let allElementsFound = true;
        for (const elName in requiredElements) {
            if (!requiredElements[elName]) {
                console.error(`Critical UI element missing: ${elName}.`);
                if (SSEL_GLOBAL) SSEL_GLOBAL.textContent = `Error: UI Element '${elName}' missing.`;
                allElementsFound = false; 
            }
        }
        if (!allElementsFound) {
             console.error("One or more critical UI elements could not be found. Page functionality will be impaired.");
        } else {
            console.log("All critical UI elements found."); // LOG 5
        }


        let currentSimTime = null; 
        let pollIntervalId = null;
        let clientSideTextTimers = {}; 
        let activeCircleBars = {}; 
        let currentViewMode = 'all'; 
        let displayedCourtNumber = null;
        window.lastFetchedData = {};

        let rotationSound = null;
        let soundsEnabled = true; 
        const soundStorageKey = `squashSync_soundsEnabled_${sessionId}`;
        let isViewLocked = false;
        const COACH_PIN = "7777"; 
        let navigationAttemptUrl = null;
        let isInFullscreenLock = false; 
        // Screen Wake Lock API related code has been removed.

        // --- Sound Toggle Logic ---
        if (toggleSoundBtn) {
             try {
                rotationSound = new Audio("{% static 'planning/sounds/rotation_alert.mp3' %}"); 
                rotationSound.preload = 'auto';
            } catch (e) { console.warn("Could not initialize rotation sound.", e); }

            function updateSoundButtonText() {
                if (toggleSoundBtn) toggleSoundBtn.textContent = soundsEnabled ? 'Mute Sounds' : 'Unmute Sounds';
            }
            const storedSoundPreference = localStorage.getItem(soundStorageKey);
            if (storedSoundPreference !== null) soundsEnabled = storedSoundPreference === 'true';
            updateSoundButtonText();

            toggleSoundBtn.addEventListener('click', () => {
                console.log("Toggle Sound button clicked."); // DEBUG LOG
                soundsEnabled = !soundsEnabled;
                localStorage.setItem(soundStorageKey, soundsEnabled);
                updateSoundButtonText();
                if (!soundsEnabled && rotationSound && !rotationSound.paused) {
                    rotationSound.pause(); rotationSound.currentTime = 0;
                }
            });
        } else { console.warn("toggleSoundBtn not found, sound controls disabled."); }


        // --- Timer Formatting & Client-Side Timers (Text & Circle) ---
        function formatTimeRemaining(seconds) { 
            if (seconds === null || seconds === undefined || isNaN(seconds) || seconds < 0) seconds = 0;
            const mins = Math.floor(seconds / 60); const secs = Math.round(seconds % 60); 
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }
        function startClientSideTextTimer(elementId, initialSeconds) { 
            if (clientSideTextTimers[elementId]) { clearInterval(clientSideTextTimers[elementId]); }
            let remainingSeconds = Number(initialSeconds); const timerElement = document.getElementById(elementId);
            if (!timerElement) { console.warn("Text timer element not found for ID:", elementId); return; } 
            timerElement.textContent = formatTimeRemaining(remainingSeconds);
            if (remainingSeconds <= 0) return; clientSideTextTimers[elementId] = setInterval(() => {
            if (remainingSeconds > 0) { remainingSeconds--; timerElement.textContent = formatTimeRemaining(remainingSeconds);
            } else { timerElement.textContent = "00:00"; clearInterval(clientSideTextTimers[elementId]); clientSideTextTimers[elementId] = null; }
            }, 1000);
        }
        function startClientSideCircleAnimation(circleKey, currentRemainingSeconds, totalSegmentSeconds) { 
            if (!activeCircleBars[circleKey] || totalSegmentSeconds < 0) { console.warn("Circle timer conditions not met for key:", circleKey); return; }
            let remainingSeconds = currentRemainingSeconds; const barInfo = activeCircleBars[circleKey];
            if (barInfo.clientIntervalId) { clearInterval(barInfo.clientIntervalId); }
            if (barInfo.instance && typeof barInfo.instance.setText === 'function') { barInfo.instance.setText(formatTimeRemaining(remainingSeconds)); }
            barInfo.clientIntervalId = setInterval(() => { if (remainingSeconds > 0) { remainingSeconds--; }
            const progress = totalSegmentSeconds > 0 ? Math.max(0, Math.min(1, remainingSeconds / totalSegmentSeconds)) : 0;
            if (barInfo.instance && typeof barInfo.instance.set === 'function') { barInfo.instance.set(progress); 
            if (typeof barInfo.instance.setText === 'function') { barInfo.instance.setText(formatTimeRemaining(remainingSeconds)); }}
            if (remainingSeconds <= 0) { if (barInfo.clientIntervalId) clearInterval(barInfo.clientIntervalId); barInfo.clientIntervalId = null; }
            }, 1000);
        }
        
        // --- Fullscreen and UI Chrome Toggling Logic ---
        function enterAppFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.warn("Fullscreen request failed:",err));
            else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen().catch(err => console.warn("Fullscreen request failed (FF):",err));
            else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen().catch(err => console.warn("Fullscreen request failed (WebKit):",err));
            else if (elem.msRequestFullscreen) elem.msRequestFullscreen().catch(err => console.warn("Fullscreen request failed (MS):",err));
        }
        function exitAppFullscreen() {
            if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
                if (document.exitFullscreen) document.exitFullscreen().catch(err => console.warn("Exit Fullscreen failed:",err));
                else if (document.mozCancelFullScreen) document.mozCancelFullScreen().catch(err => console.warn("Exit Fullscreen failed (FF):",err));
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen().catch(err => console.warn("Exit Fullscreen failed (WebKit):",err));
                else if (document.msExitFullscreen) document.msExitFullscreen().catch(err => console.warn("Exit Fullscreen failed (MS):",err));
            }
        }

        function setLockMode(lock) {
            console.log(`setLockMode called with: ${lock}. Current isViewLocked: ${isViewLocked}`); // DEBUG LOG
            isViewLocked = lock;
            if (lock) {
                isInFullscreenLock = true;
                enterAppFullscreen();
                document.body.classList.add('fullscreen-locked-mode');
                if (toggleLockViewBtn) {
                    toggleLockViewBtn.textContent = 'Unlock View';
                    toggleLockViewBtn.classList.add('unlock-mode'); 
                }
                 console.log("Lock mode activated, fullscreen requested, body class added.");// DEBUG LOG
            } else {
                if (isInFullscreenLock) { 
                     exitAppFullscreen();
                }
                document.body.classList.remove('fullscreen-locked-mode');
                document.body.classList.remove('single-court-view'); 
                if (toggleLockViewBtn) {
                    toggleLockViewBtn.textContent = 'Lock View';
                    toggleLockViewBtn.classList.remove('unlock-mode');
                }
                isInFullscreenLock = false; 
                currentViewMode = 'all';
                displayedCourtNumber = null;
                if (viewAllCourtsBtn) viewAllCourtsBtn.classList.add('active');
                if (selectCourtViewDropdown) selectCourtViewDropdown.value = 'all';
                console.log("Lock mode deactivated, fullscreen exited, body class removed.");// DEBUG LOG
            }
            
            // Always re-render or fetch fresh data when lock mode changes
            // Ensure lastFetchedData is valid before trying to use it
            if (window.lastFetchedData && typeof window.lastFetchedData === 'object' && window.lastFetchedData.session_info) {
                console.log("setLockMode: Updating display with lastFetchedData.");
                updateDisplay(window.lastFetchedData);
            } else {
                console.log("setLockMode: lastFetchedData invalid or empty, fetching fresh data for UI update after lock change.");
                fetchLiveState(); // Fetch fresh data to ensure UI consistency
            }
        }
        
        if (toggleLockViewBtn) { 
            toggleLockViewBtn.addEventListener('click', () => {
                console.log("Toggle Lock View button clicked. isViewLocked:", isViewLocked); // DEBUG LOG
                if (isViewLocked) { 
                    navigationAttemptUrl = null; 
                    showPinModal();
                } else { 
                    setLockMode(true);
                }
            });
        } else { console.warn("toggleLockViewBtn not found, lock functionality disabled."); }

        function showPinModal() {
            console.log("showPinModal called"); // DEBUG LOG
            if(pinModal) {
                pinErrorMessage.textContent = ''; 
                pinInput.value = '';
                pinModal.style.display = 'flex';
                if(pinInput) pinInput.focus(); else console.warn("pinInput not found in showPinModal");
            } else { console.warn("pinModal not found in showPinModal"); }
        }
        function hidePinModal() {
            console.log("hidePinModal called"); // DEBUG LOG
            if(pinModal) pinModal.style.display = 'none';
        }

        if (pinSubmitBtn) { 
            pinSubmitBtn.addEventListener('click', () => {
                console.log("PIN Submit button clicked"); // DEBUG LOG
                if (pinInput && pinInput.value === COACH_PIN) {
                    setLockMode(false); 
                    hidePinModal();
                    if (navigationAttemptUrl) {
                        window.location.href = navigationAttemptUrl;
                        navigationAttemptUrl = null;
                    }
                } else {
                    if(pinErrorMessage) pinErrorMessage.textContent = 'Incorrect PIN.';
                    if(pinInput) { pinInput.value = ''; pinInput.focus(); }
                }
            });
        } else { console.warn("pinSubmitBtn not found"); }

        if (pinCancelBtn) { 
            pinCancelBtn.addEventListener('click', () => {
                console.log("PIN Cancel button clicked"); // DEBUG LOG
                hidePinModal();
                navigationAttemptUrl = null; 
            });
        } else { console.warn("pinCancelBtn not found"); }

        if (pinInput) {
            pinInput.addEventListener('keypress', function(event) {
                if (event.key === "Enter") { event.preventDefault(); if(pinSubmitBtn) pinSubmitBtn.click(); }
            });
        } else { console.warn("pinInput not found"); }

        function handleFullscreenChange() {
            const isBrowserCurrentlyFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement);
            console.log(`Fullscreen change event. Browser fullscreen: ${isBrowserCurrentlyFullscreen}, isInFullscreenLock: ${isInFullscreenLock}`); // DEBUG LOG
            if (!isBrowserCurrentlyFullscreen && isInFullscreenLock) { 
                console.log("Fullscreen exited externally while in our controlled lock mode. Reverting lock state.");
                setLockMode(false); 
            }
            // This ensures our internal state matches browser if it exits for other reasons
            if (isInFullscreenLock && !isBrowserCurrentlyFullscreen) {
                 isInFullscreenLock = false;
                 // We might not want to call setLockMode(false) again if it was already called
            }
        }
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        
        const protectedLinks = document.querySelectorAll('header.main-header a, ul.nav-links-container a'); 
        protectedLinks.forEach(link => { /* ... as before ... */ });
        window.addEventListener('beforeunload', function (e) { /* ... as before ... */ });

        // --- Main Update Display Function ---
        function updateDisplay(data) {
            // (The full updateDisplay function from the previous correct version should be here)
            // Ensure all SSEL_GLOBAL replacements are done and element checks are in place.
            // For brevity, this is a placeholder for the full function.
            console.log("updateDisplay() called with data:", data); // LOG 6
            if (typeof data !== 'object' || data === null || typeof data.session_info !== 'object' || data.session_info === null) {
                console.error("updateDisplay: Received invalid data object or missing session_info.", data);
                if (SSEL_GLOBAL && SSEL_GLOBAL.textContent.startsWith("Loading")) { SSEL_GLOBAL.textContent = "Error: Data unavailable."; }
                if (courtsAreaDiv) courtsAreaDiv.innerHTML = '<p class="no-data">Error: Could not display session data.</p>';
                if (preSessionPlayerListContainer) preSessionPlayerListContainer.style.display = 'none';
                if(currentBlockInfoEl) currentBlockInfoEl.innerHTML = ""; if(nextRotationInfoEl) nextRotationInfoEl.innerHTML = ""; if(nextBlockPreviewInfoEl) nextBlockPreviewInfoEl.innerHTML = "";
                return;
            }
            if (data.error) { 
                if (SSEL_GLOBAL) SSEL_GLOBAL.textContent = `Error: ${data.error}`;
                if (courtsAreaDiv) courtsAreaDiv.innerHTML = `<p class="no-data">Error: ${data.error}</p>`;
                if (preSessionPlayerListContainer) preSessionPlayerListContainer.style.display = 'none';
                if(currentBlockInfoEl) currentBlockInfoEl.innerHTML = ""; if(nextRotationInfoEl) nextRotationInfoEl.innerHTML = ""; if(nextBlockPreviewInfoEl) nextBlockPreviewInfoEl.innerHTML = "";
                return;
            }
            
            console.log("Live Session JS (Full): Processing valid data in updateDisplay:", data); 
            window.lastFetchedData = data;

            if(currentPollTimeDisplay) currentPollTimeDisplay.textContent = data.effective_current_time_iso ? new Date(data.effective_current_time_iso).toLocaleString() : new Date().toLocaleString();
            
            let mainStatus = data.session_info.status_message || "Status N/A"; 
            if (data.is_rotation_alert_active) { mainStatus = "ROTATE NOW!"; } 
            else if (isViewLocked) { 
                if (data.current_time_block && data.current_time_block.block_focus) { mainStatus = `${data.current_time_block.block_focus}`; } 
                else if (data.session_info.is_live) { mainStatus = "Session In Progress"; } 
            } else { 
                if (data.current_time_block && data.current_time_block.block_focus) { mainStatus = `Block: ${data.current_time_block.block_focus || 'Activity'}`; }
            }
            if (SSEL_GLOBAL) SSEL_GLOBAL.textContent = mainStatus;
            
            if (preSessionPlayerListContainer) {
                if (!data.session_info.is_live && data.session_info.attending_players_names && data.session_info.attending_players_names.length > 0) {
                    let playerListHtml = '<h4><i class="bi bi-people-fill"></i> Attending Players:</h4><ul>';
                    data.session_info.attending_players_names.forEach(name => { playerListHtml += `<li>${name}</li>`; });
                    playerListHtml += '</ul>';
                    preSessionPlayerListContainer.innerHTML = playerListHtml;
                    preSessionPlayerListContainer.style.display = 'block';
                    if (courtsAreaDiv) courtsAreaDiv.innerHTML = ''; 
                } else {
                    preSessionPlayerListContainer.style.display = 'none';
                }
            }


            if (data.current_time_block) {
                if (currentBlockInfoEl) {
                    currentBlockInfoEl.innerHTML = `<strong>Block:</strong> ${data.current_time_block.block_focus || 'Activity'} 
                        (Ends in: <span class="time-remaining" id="blockTimer_${data.current_time_block.id}">${formatTimeRemaining(data.current_time_block.time_remaining_in_block_seconds)}</span>)`;
                    startClientSideTextTimer(`blockTimer_${data.current_time_block.id}`, data.current_time_block.time_remaining_in_block_seconds);
                }
                if (nextRotationInfoEl) {
                    if (data.current_time_block.next_rotation_due_datetime_iso) {
                        const nextRotationDue = new Date(data.current_time_block.next_rotation_due_datetime_iso);
                        const effectiveNow = new Date(data.effective_current_time_iso);
                        const diffSecondsRotation = Math.max(0, Math.round((nextRotationDue - effectiveNow) / 1000));
                        nextRotationInfoEl.innerHTML = `<strong>Next Rotation:</strong> In <span class="time-remaining" id="rotationTimer_${data.current_time_block.id}">${formatTimeRemaining(diffSecondsRotation)}</span>`;
                        startClientSideTextTimer(`rotationTimer_${data.current_time_block.id}`, diffSecondsRotation);
                    } else { nextRotationInfoEl.textContent = "No further rotations in this block."; }
                }
            } else { 
                if(currentBlockInfoEl) currentBlockInfoEl.innerHTML = (data.session_info.is_live && (!preSessionPlayerListContainer || preSessionPlayerListContainer.style.display === 'none')) ? "<p>No active block.</p>" : "";
                if(nextRotationInfoEl) nextRotationInfoEl.textContent = ""; 
            }

            if (data.next_time_block_preview) {
                if(nextBlockPreviewInfoEl) nextBlockPreviewInfoEl.innerHTML = `<strong>Next:</strong> ${data.next_time_block_preview.block_focus || 'N/A'} 
                    (Starts in: <span class="time-remaining" id="nextBlockTimer">${formatTimeRemaining(data.next_time_block_preview.starts_in_seconds)}</span>)`;
                startClientSideTextTimer('nextBlockTimer', data.next_time_block_preview.starts_in_seconds);
            } else { if(nextBlockPreviewInfoEl) nextBlockPreviewInfoEl.textContent = ""; }
            
            if(data.is_rotation_alert_active && toggleSoundBtn && soundsEnabled && rotationSound) { /* ... same sound play ... */ }
            else if (liveStatusContainer) { liveStatusContainer.classList.remove('rotation-alert-active'); }


            const currentVisibleActivityInstanceKeys = new Set();
            if (data.courts_data && data.session_info.is_live) { 
                data.courts_data.forEach(court => {
                    if (court.current_activity) {
                        const activityData = court.current_activity;
                        const key = `s${sessionId}_b${data.current_time_block ? data.current_time_block.id : 'x'}_c${court.court_number}_a${activityData.activity_id}`;
                        currentVisibleActivityInstanceKeys.add(key);
                    }
                });
            }
            for (const key in activeCircleBars) {
                if (!currentVisibleActivityInstanceKeys.has(key)) {
                    if (activeCircleBars[key].clientIntervalId) clearInterval(activeCircleBars[key].clientIntervalId);
                    if (activeCircleBars[key].instance && typeof activeCircleBars[key].instance.destroy === 'function') {
                        try { activeCircleBars[key].instance.destroy(); } catch(e) { console.warn("Error destroying circle bar (cleanup):", e); }
                    }
                    delete activeCircleBars[key];
                }
            }

            if (data.session_info.is_live) { 
                if(courtsAreaDiv) courtsAreaDiv.innerHTML = ''; 
                let courtsToDisplay = data.courts_data || [];
                if (currentViewMode !== 'all' && displayedCourtNumber !== null) {
                    courtsToDisplay = courtsToDisplay.filter(c => c.court_number === displayedCourtNumber);
                    document.body.classList.toggle('single-court-view', true); 
                } else {
                    document.body.classList.toggle('single-court-view', false);
                }

                let courtCardsHtml = "";
                if (courtsToDisplay.length > 0) {
                    courtsToDisplay.forEach(court => {
                        let courtHtmlSegment = `<div class="court-card ${currentViewMode !== 'all' && court.court_number === displayedCourtNumber ? 'court-active' : ''}"><h3>Court ${court.court_number}</h3>`;
                        courtHtmlSegment += `<div class="activity-info">`;
                        if (court.current_activity) {
                            const activityData = court.current_activity;
                            const activityInstanceKey = `s${sessionId}_b${data.current_time_block ? data.current_time_block.id : 'x'}_c${court.court_number}_a${activityData.activity_id}`;
                            const circleContainerDomId = `circle_timer_container_${activityInstanceKey}`;
                            courtHtmlSegment += `<h4>Current Activity:</h4><p><strong>${activityData.name}</strong></p>`;
                            courtHtmlSegment += `<div class="circle-timer-container" id="${circleContainerDomId}"></div>`;
                        } else { courtHtmlSegment += `<p class="no-activity">No current activity.</p>`; }
                        if (court.next_activity_in_block) { courtHtmlSegment += `<p class="next-activity">Next: ${court.next_activity_in_block.name} (${court.next_activity_in_block.duration_minutes} min)</p>`;}
                        courtHtmlSegment += `</div><div class="player-list-container"><h4>Players:</h4><ul class="player-list">`; 
                        if (court.assigned_players && court.assigned_players.length > 0) {
                            court.assigned_players.forEach(player => { courtHtmlSegment += `<li>${player}</li>`; });
                        } else { courtHtmlSegment += `<li>No players assigned.</li>`; }
                        courtHtmlSegment += `</ul></div></div>`; 
                        courtCardsHtml += courtHtmlSegment;
                    });
                   if(courtsAreaDiv) courtsAreaDiv.innerHTML = courtCardsHtml; 

                    courtsToDisplay.forEach(court => {
                        if (court.current_activity) {
                            const activityData = court.current_activity;
                            const serverRemainingSeconds = activityData.time_remaining_in_activity_seconds;
                            const activityInstanceKey = `s${sessionId}_b${data.current_time_block ? data.current_time_block.id : 'x'}_c${court.court_number}_a${activityData.activity_id}`;
                            const circleContainerDomId = `circle_timer_container_${activityInstanceKey}`;
                            const containerElement = document.getElementById(circleContainerDomId);

                            if (!containerElement) {
                                if (activeCircleBars[activityInstanceKey]) { 
                                    if(activeCircleBars[activityInstanceKey].clientIntervalId) clearInterval(activeCircleBars[activityInstanceKey].clientIntervalId);
                                    delete activeCircleBars[activityInstanceKey]; } return; }
                            let totalSegmentSecondsForThisInstance;
                            const existingBarInfo = activeCircleBars[activityInstanceKey];
                            if (existingBarInfo) { 
                                totalSegmentSecondsForThisInstance = existingBarInfo.totalSegmentSeconds;
                                if (existingBarInfo.clientIntervalId) clearInterval(existingBarInfo.clientIntervalId);
                                if (existingBarInfo.instance && typeof existingBarInfo.instance.destroy === 'function') {
                                    try { existingBarInfo.instance.destroy(); } catch(e) {/*ignore*/}
                                }
                            } else { totalSegmentSecondsForThisInstance = serverRemainingSeconds; }
                            
                            if (totalSegmentSecondsForThisInstance >= 0 && containerElement.id === circleContainerDomId ) {
                                 const bar = new ProgressBar.Circle(containerElement, {
                                    strokeWidth: 7, easing: 'linear', color: 'var(--link-color, #0d6efd)',
                                    trailColor: 'var(--border-light, #e9ecef)', trailWidth: 2,
                                    svgStyle: { width: '100%', height: '100%' },
                                    text: { className: 'progressbar-text', autoStyleContainer: false }
                                });
                                const initialProgress = totalSegmentSecondsForThisInstance > 0 ? Math.max(0, Math.min(1, serverRemainingSeconds / totalSegmentSecondsForThisInstance)) : 0;
                                bar.set(initialProgress); bar.setText(formatTimeRemaining(serverRemainingSeconds));
                                activeCircleBars[activityInstanceKey] = {
                                    instance: bar, totalSegmentSeconds: totalSegmentSecondsForThisInstance, clientIntervalId: null
                                };
                                if (serverRemainingSeconds > 0) {
                                    startClientSideCircleAnimation(activityInstanceKey, serverRemainingSeconds, totalSegmentSecondsForThisInstance);
                                }
                            } else if (existingBarInfo) { delete activeCircleBars[activityInstanceKey]; }
                        }
                    });
                } else if (courtsAreaDiv) { 
                     courtsAreaDiv.innerHTML = "<p class='no-data'>No court activities assigned for this block.</p>";
                }
            } else if (preSessionPlayerListContainer && preSessionPlayerListContainer.style.display === 'none') { 
                if (data.session_info.status_message.includes("Finished")) {
                    if(courtsAreaDiv) courtsAreaDiv.innerHTML = "<p class='no-data'>Session has finished.</p>";
                } else if (!data.session_info.status_message.includes("starts") && !data.session_info.status_message.includes("starting")) { 
                    if(courtsAreaDiv) courtsAreaDiv.innerHTML = "<p class='no-data'>Waiting for session details...</p>";
                }
            }
        } // End of updateDisplay
        
        // --- fetchLiveState and other listeners ---
        function fetchLiveState() { 
            console.log("fetchLiveState() called."); // LOG 7
            if (!apiUrlForSessionState) { 
                if (SSEL_GLOBAL) SSEL_GLOBAL.textContent = "Config error: API URL missing."; 
                console.error("CRITICAL: fetchLiveState called without API URL.");
                return; 
            }
            let urlToFetch = apiUrlForSessionState; 
            if (currentSimTime) { 
                const year = currentSimTime.getFullYear(); const month = String(currentSimTime.getMonth() + 1).padStart(2, '0');
                const day = String(currentSimTime.getDate()).padStart(2, '0'); const hours = String(currentSimTime.getHours()).padStart(2, '0');
                const minutes = String(currentSimTime.getMinutes()).padStart(2, '0'); const seconds = String(currentSimTime.getSeconds()).padStart(2, '0');
                const effectiveSimTimeISO = `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
                urlToFetch = `${apiUrlForSessionState}?sim_time_iso=${encodeURIComponent(effectiveSimTimeISO)}`;
            }
            if(apiUrlDisplay) apiUrlDisplay.textContent = urlToFetch;
            
            console.log("Fetching state from:", urlToFetch); // LOG 8
            fetch(urlToFetch)
                .then(response => { 
                    console.log("Fetch response status:", response.status); // LOG 9
                    if (!response.ok) { 
                        return response.text().then(text => {
                            console.error("Fetch HTTP error response text:", text);
                            throw new Error(`HTTP error! Status: ${response.status}. Details: ${text.substring(0,100)}`);
                        });
                    }
                    return response.json().catch(jsonError => { 
                        console.error("Error parsing JSON response:", jsonError);
                        throw new Error(`Invalid JSON response from server. ${jsonError.message}`);
                    });
                })
                .then(data => {
                    console.log("Fetch successful, JSON parsed. Data received for updateDisplay:", data); // LOG 10
                    if (data && data.error) { 
                        console.error("API returned application error:", data.error);
                        if (SSEL_GLOBAL) SSEL_GLOBAL.textContent = `Error: ${data.error}`;
                        if (courtsAreaDiv) courtsAreaDiv.innerHTML = `<p class="no-data">Error: ${data.error}</p>`;
                        return; 
                    }
                    updateDisplay(data); 
                })
                .catch(error => { 
                    console.error("Fetch/Processing error in fetchLiveState:", error); 
                    if (SSEL_GLOBAL) { 
                        SSEL_GLOBAL.textContent = `Error: ${error.message}. Retrying...`;
                    }
                    if (courtsAreaDiv) courtsAreaDiv.innerHTML = `<p class="no-data">Error fetching update. Retrying...</p>`;
                });
        }
        
        if (setSimTimeBtn) { setSimTimeBtn.addEventListener('click', function() { const i=simTimeInput.value; if(i){currentSimTime=new Date(i);if(isNaN(currentSimTime.getTime())){alert("Invalid date format");currentSimTime=null;return;}localStorage.setItem(`simTime_${sessionId}`,currentSimTime.toISOString());fetchLiveState();}else{alert("Enter date/time.");}}); }
        if (useRealTimeBtn) { useRealTimeBtn.addEventListener('click', function() { currentSimTime=null;if(simTimeInput)simTimeInput.value='';localStorage.removeItem(`simTime_${sessionId}`);fetchLiveState();}); }
        if (advanceTimeBtn) { advanceTimeBtn.addEventListener('click', function() { if(!currentSimTime){currentSimTime=new Date();}currentSimTime.setMinutes(currentSimTime.getMinutes()+5);const Y=currentSimTime.getFullYear(),M=String(currentSimTime.getMonth()+1).padStart(2,'0'),D=String(currentSimTime.getDate()).padStart(2,'0'),h=String(currentSimTime.getHours()).padStart(2,'0'),m=String(currentSimTime.getMinutes()).padStart(2,'0');if(simTimeInput)simTimeInput.value=`${Y}-${M}-${D}T${h}:${m}`;localStorage.setItem(`simTime_${sessionId}`,currentSimTime.toISOString());fetchLiveState();}); }
        
        if (viewAllCourtsBtn) { viewAllCourtsBtn.addEventListener('click', function() {currentViewMode='all';displayedCourtNumber=null;this.classList.add('active');if(selectCourtViewDropdown)selectCourtViewDropdown.value='all';document.body.classList.remove('single-court-view');if(window.lastFetchedData && Object.keys(window.lastFetchedData).length>0 && window.lastFetchedData.session_info)updateDisplay(window.lastFetchedData);else fetchLiveState();}); }
        if (selectCourtViewDropdown) { selectCourtViewDropdown.addEventListener('change', function() {if(this.value==='all'){currentViewMode='all';displayedCourtNumber=null;if(viewAllCourtsBtn)viewAllCourtsBtn.classList.add('active');document.body.classList.remove('single-court-view');}else{currentViewMode='court_specific';displayedCourtNumber=parseInt(this.value);if(viewAllCourtsBtn)viewAllCourtsBtn.classList.remove('active');document.body.classList.add('single-court-view');}if(window.lastFetchedData&&Object.keys(window.lastFetchedData).length>0 && window.lastFetchedData.session_info)updateDisplay(window.lastFetchedData);else fetchLiveState();}); }

        const initialUrlParams = new URLSearchParams(window.location.search); 
        const initialSimTimeParam = initialUrlParams.get('sim_time');
        if(initialSimTimeParam){try{let pDate=new Date(initialSimTimeParam);if(initialSimTimeParam.length===16){pDate=new Date(initialSimTimeParam+":00");}if(!isNaN(pDate.getTime())){currentSimTime=pDate;const Y=currentSimTime.getFullYear(),M=String(currentSimTime.getMonth()+1).padStart(2,'0'),D=String(currentSimTime.getDate()).padStart(2,'0'),h=String(currentSimTime.getHours()).padStart(2,'0'),m=String(currentSimTime.getMinutes()).padStart(2,'0');if(simTimeInput)simTimeInput.value=`${Y}-${M}-${D}T${h}:${m}`;}}catch(e){console.warn("Could not parse sim_time from URL",e);}}
        else{const storedSimTimeISO=localStorage.getItem(`simTime_${sessionId}`);if(storedSimTimeISO){currentSimTime=new Date(storedSimTimeISO);if(!isNaN(currentSimTime.getTime())){const localDateForInput=new Date(currentSimTime.getTime()-(currentSimTime.getTimezoneOffset()*60000));const Y=localDateForInput.getFullYear(),M=String(localDateForInput.getMonth()+1).padStart(2,'0'),D=String(localDateForInput.getDate()).padStart(2,'0'),h=String(localDateForInput.getHours()).padStart(2,'0'),m=String(localDateForInput.getMinutes()).padStart(2,'0');if(simTimeInput)simTimeInput.value=`${Y}-${M}-${D}T${h}:${m}`; }else{currentSimTime=null;}}}
        
        // --- Initial API call and interval setup ---
        if (apiUrlForSessionState) { 
            console.log("Attempting initial fetchLiveState(). API URL is set."); // LOG 11
            fetchLiveState(); 
            pollIntervalId = setInterval(fetchLiveState, 5000); 
            document.addEventListener("visibilitychange", function() { 
                if (document.hidden) {
                    if (pollIntervalId) clearInterval(pollIntervalId); 
                    pollIntervalId = null; 
                } else {
                    if (!pollIntervalId) { 
                        fetchLiveState(); 
                        pollIntervalId = setInterval(fetchLiveState, 5000);
                    }
                }
            });
        } else {
            console.error("CRITICAL: API URL is not set. Polling cannot start.");
            if (SSEL_GLOBAL) SSEL_GLOBAL.textContent = "CRITICAL ERROR: Page cannot load data.";
        }

    }); // End DOMContentLoaded
    </script>
{% endblock %}
